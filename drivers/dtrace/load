#! /bin/sh

# Paul Fox July 2008

# Simple script to load the driver and get it ready.

fast=no

SUDO="setuid root"
if [ ! -f $HOME/bin/setuid ]; then
	SUDO=sudo
fi

usage ()
{
	echo "load: Load dtrace driver"
    	echo "Usage: load [-fast] [-here]"
	echo ""
	echo "load -here"
	echo ""
	echo "     Turn on HERE() macro output to /var/log/messages"
	echo ""
	echo "load -fast"
	echo ""
	echo "     Dont do dtrace -l on startup (avoid polluting /var/log/messages)"
	exit 1
}

here=0
while [ "$1" != "" ]
do
  case "$1" in
    *fast)
    	fast=yes
	shift
	;;
    -here)
    	here=1
	shift
	;;
    *help)
    	usage
	;;
    *)
    	usage
	;;
  esac
done

if [ "$1" != "" ] ; then
	fast=$1
	shift
fi

echo "Syncing..."
sync ; sync
if [ -e /dev/dtrace ]; then
	echo rmmod dtracedrv
	$SUDO rmmod dtracedrv
	#sleep 1
	sync ; sync
fi

#####################################################################
#   Here  goes...we could crash the kernel... We sleep for a bit at
#   present  since we need the /dev entries to appear. Chmod 666 so
#   we can avoid being root all the time whilst we debug.
#####################################################################
echo "Loading: dtracedrv.ko"
$SUDO insmod dtracedrv.ko dtrace_here=$here
sleep 1
$SUDO chmod 666 /dev/dtrace
$SUDO chmod 666 /dev/fbt

#####################################################################
#   Need to 'export' GPL symbols to the driver so we can call these
#   functions. Until this is done, the driver is a little unsafe(!)
#####################################################################
echo "Preparing symbols..."
for s in \
	access_process_vm	\
	kallsyms		\
	get_symbol_offset	\
	modules		        \
	__symbol_get		\
	sys_call_table		\
	kern_addr_valid		\
	hrtimer_init		\
	hrtimer_start		\
	hrtimer_cancel
do
	grep " $s" /proc/kallsyms >/dev/fbt
done

#####################################################################
#   Keep  a  copy of probes to avoid polluting /var/log/messages as
#   we debug the driver..
#####################################################################
if [ $fast = yes ]; then
	echo "Probes available:"
	pname=`date +/tmp/probes-%Y%m%d-%H:%M`
	if [ -f /tmp/probes.current -a ! -f $pname ] ; then
		mv /tmp/probes.current /tmp/probes.prev
	fi
	../../build/dtrace -l | tee $pname | wc -l 
	rm -f /tmp/probes.current
	ln -s $pname /tmp/probes.current
fi
